<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DocMatch - Client-Side OCR Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.3.136/build/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdn.jsdelivr.net/npm/pdfjs-dist@4.3.136/build/pdf.worker.min.js`;
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-active { border-color: #3b82f6; color: #3b82f6; }
        .drop-zone { border: 2px dashed #d1d5db; transition: background-color 0.2s; }
        .drop-zone.drag-over { background-color: #e0f2fe; border-color: #3b82f6; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .mismatch-row { background-color: #fee2e2; }
        .mismatch-cell { font-weight: bold; color: #dc2626; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
     <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">

        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">DocMatch OCR</h1>
            <p class="text-md text-gray-600 mt-1">An internal tool for document verification, extraction, and conversion.</p>
        </header>

        <div class="p-4 mb-6 bg-blue-50 border border-blue-200 rounded-lg text-blue-800 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6 mr-3 text-blue-500"><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path><circle cx="12" cy="12" r="4"></circle></svg>
            <p><strong class="font-semibold">Powered by Tesseract.js:</strong> This tool uses open-source OCR that runs 100% in your browser. No data is sent to external servers.</p>
        </div>

        <div class="mb-8 border-b border-gray-200">
            <nav class="flex space-x-8" aria-label="Tabs">
                <button id="tab-verify" onclick="switchTab('verify')" class="px-1 pb-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 tab-active">File Verification</button>
                <button id="tab-extract" onclick="switchTab('extract')" class="px-1 pb-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">PDF Table Extraction</button>
                <button id="tab-convert" onclick="switchTab('convert')" class="px-1 pb-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Excel to XML</button>
            </nav>
        </div>

        <main id="content-area">
            <div id="verify-content" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div id="verify-soft-drop-zone" class="drop-zone p-6 rounded-lg bg-white shadow-sm text-center">
                        <h3 class="font-semibold text-lg mb-2">1. Upload Excel Files</h3>
                        <input type="file" id="verify-soft-input" class="hidden" accept=".xlsx, .xls" multiple>
                        <button onclick="document.getElementById('verify-soft-input').click()" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">Browse Files</button>
                        <div id="verify-soft-filenames" class="mt-4 text-sm text-gray-600 text-left px-4"></div>
                    </div>
                    <div id="verify-hard-drop-zone" class="drop-zone p-6 rounded-lg bg-white shadow-sm text-center">
                        <h3 class="font-semibold text-lg mb-2">2. Upload Scanned PDF</h3>
                        <input type="file" id="verify-hard-input" class="hidden" accept=".pdf">
                        <button onclick="document.getElementById('verify-hard-input').click()" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">Browse File</button>
                        <p id="verify-hard-filename" class="mt-4 text-sm text-gray-600"></p>
                    </div>
                </div>
                <div class="text-center">
                    <button id="verify-btn" onclick="runVerification()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 font-semibold disabled:bg-gray-400" disabled>Compare Files</button>
                </div>
                <div id="verify-loader" class="hidden justify-center items-center py-6 flex-col space-y-2">
                    <div class="loader"></div>
                    <p id="ocr-status-verify" class="text-sm text-gray-600"></p>
                </div>
                <div id="verify-results" class="hidden bg-white p-6 rounded-lg shadow-sm fade-in"></div>
            </div>
            <div id="extract-content" class="hidden space-y-6">...</div>
             <div id="convert-content" class="hidden space-y-6">...</div>
        </main>
    </div>

    <script>
        // --- Global State & Setup ---
        let softFiles = [], hardFile = null, extractFile = null, convertFile = null;
        document.addEventListener('DOMContentLoaded', () => {
            setupDropZone('verify-soft-drop-zone', 'verify-soft-input', (files) => softFiles = files, 'verify-soft-filenames', true);
            setupDropZone('verify-hard-drop-zone', 'verify-hard-input', (file) => hardFile = file, 'verify-hard-filename');
        });

        // --- UI Management ---
        function switchTab(tab) { /* Unchanged */ }
        function setupDropZone(id, inputId, setter, filenameId, multiple = false) { /* Unchanged */ }
        function handleFileChange(files, setter, el, multiple) { /* Unchanged */ }
        function checkAllFilesAndEnableButtons() { document.getElementById('verify-btn').disabled = !(softFiles.length > 0 && hardFile); }
        function showLoader(loaderId, statusElId, message = '') {
            document.getElementById(loaderId).style.display = 'flex';
            if(statusElId) document.getElementById(statusElId).textContent = message;
        }
        function hideLoader(loaderId) { document.getElementById(loaderId).style.display = 'none'; }
        function displayError(resultsId, error) {
            const el = document.getElementById(resultsId);
            el.innerHTML = `<div class="p-4 bg-red-100 border-red-300 rounded-lg text-red-900"><strong class="font-semibold">An Error Occurred:</strong><p class="mt-2">${error.message || 'Unknown error'}</p></div>`;
            el.classList.remove('hidden');
        }

        // --- File & Data Helpers ---
        function readExcelFile(file) { /* Unchanged */ }
        function downloadFile(content, fileName, mimeType) { /* Unchanged */ }
        function escapeXml(unsafe) { /* Unchanged */ }

        // --- OCR and Comparison Logic ---
        function normalizeValue(value) {
            if (value === undefined || value === null) return '';
            return String(value).trim().replace(/[\p{Sc},]/gu, '').toLowerCase();
        }

        /**
         * NEW: Creates a "fingerprint" from a row's data without needing headers.
         * It finds the most likely amount, name, and ID/account number.
         */
        function createRowFingerprint(row) {
            let amount = '', name = '', id = '';
            // Find Amount: looks for a number with a decimal, or the largest number.
            let potentialAmounts = row.map(cell => String(cell).replace(/,/g, '')).filter(cell => !isNaN(parseFloat(cell)) && isFinite(cell));
            potentialAmounts.sort((a, b) => b.length - a.length);
            if (potentialAmounts.length > 0) amount = parseFloat(potentialAmounts[0]).toFixed(2);

            // Find Name: looks for the longest text-heavy cell.
            let potentialNames = row.filter(cell => /[a-zA-Zក-ឡ]/.test(cell) && !/^\d/.test(cell)); // Contains letters, doesn't start with a digit
            potentialNames.sort((a, b) => b.length - a.length);
            if(potentialNames.length > 0) name = normalizeValue(potentialNames[0]).substring(0, 10); // First 10 chars of longest text

            // Find ID: looks for a long number-heavy cell that isn't the amount.
            let potentialIds = row.filter(cell => /\d/.test(cell) && parseFloat(String(cell).replace(/,/g, '')).toFixed(2) !== amount);
            potentialIds.sort((a, b) => b.length - a.length);
            if(potentialIds.length > 0) id = normalizeValue(potentialIds[0]);

            if (!amount) return null; // A fingerprint is not valid without an amount.
            return `${amount}|${name}|${id}`;
        }
        
        async function runClientSideOcr(file, statusElId) { /* Unchanged from previous version */ }
        function parseOcrTextToTable(text) { /* Unchanged from previous version */ }

        /**
         * REWRITTEN: Main Verification Logic using Fingerprinting
         */
        async function runVerification() {
            showLoader('verify-loader', 'ocr-status-verify');
            const resultsEl = document.getElementById('verify-results');
            resultsEl.classList.add('hidden');
            resultsEl.innerHTML = '';
            
            try {
                // 1. Read Excel data
                const allSoftDataArrays = await Promise.all(softFiles.map(file => readExcelFile(file)));
                let softRows = [];
                allSoftDataArrays.forEach(data => {
                    if (data && data.length > 1) softRows.push(...data.slice(1));
                });
                if (softRows.length === 0) throw new Error("Excel files contain no data rows.");
                const softHeaders = allSoftDataArrays.find(d => d.length > 0)?.[0] || [];

                // 2. Read PDF data using client-side OCR
                const hardDataRaw = await runClientSideOcr(hardFile, 'ocr-status-verify');
                if (!hardDataRaw || hardDataRaw.length === 0) throw new Error("OCR could not extract any data from the PDF.");
                const hardRows = hardDataRaw.slice(1);
                const hardHeaders = hardDataRaw[0] || [];

                // 3. Create fingerprint maps for both data sets
                const softDataMap = new Map();
                softRows.forEach(row => {
                    const fingerprint = createRowFingerprint(row);
                    if (fingerprint) softDataMap.set(fingerprint, { row, matched: false });
                });

                const hardDataMap = new Map();
                hardRows.forEach(row => {
                    const fingerprint = createRowFingerprint(row);
                    if (fingerprint) hardDataMap.set(fingerprint, { row, matched: false });
                });

                // 4. Find matches
                const matches = [];
                for (const [fingerprint, softItem] of softDataMap.entries()) {
                    if (hardDataMap.has(fingerprint)) {
                        const hardItem = hardDataMap.get(fingerprint);
                        matches.push({ type: 'match', soft: softItem.row, hard: hardItem.row });
                        softItem.matched = true;
                        hardItem.matched = true;
                    }
                }

                // 5. Collect unmatched rows
                const mismatches = [];
                softDataMap.forEach(item => { if (!item.matched) mismatches.push({ type: 'missing_in_hard', data: item.row }); });
                hardDataMap.forEach(item => { if (!item.matched) mismatches.push({ type: 'missing_in_soft', data: item.row }); });

                // 6. Render results
                let html = `<h3 class="text-xl font-bold mb-4">Comparison Results</h3>`;
                const totalMismatches = mismatches.length;

                if (totalMismatches === 0 && matches.length > 0) {
                    html += `<p class="p-4 bg-green-100 text-green-800 rounded-md">✅ Found ${matches.length} matching records perfectly!</p>`;
                } else {
                    html += `<p class="text-lg font-semibold text-gray-800 mb-4">Found ${matches.length} ${matches.length === 1 ? 'match' : 'matches'} and <span class="text-red-600">${totalMismatches} ${totalMismatches === 1 ? 'mismatch' : 'mismatches'}</span>.</p>`;
                }
                
                html += `<div class="overflow-x-auto"><table class="w-full text-sm text-left">
                    <thead class="bg-gray-100 text-gray-700"><tr>
                        <th class="p-3">Source</th>${softHeaders.map(h => `<th class="p-3">${h}</th>`).join('')}
                    </tr></thead><tbody>`;

                // Display matched rows
                matches.forEach(match => {
                    html += `<tr class="border-b"><td class="p-3 font-medium">Excel</td>${match.soft.map(cell => `<td class="p-3">${cell}</td>`).join('')}</tr>`;
                    // Attempt to align hard data columns with soft headers for display
                    const reorderedHardRow = softHeaders.map((sh, i) => match.hard[i] || '');
                    html += `<tr class="border-b"><td class="p-3 font-medium">PDF</td>${reorderedHardRow.map(cell => `<td class="p-3">${cell}</td>`).join('')}</tr>`;
                });

                // Display mismatched rows
                mismatches.forEach(mismatch => {
                    if (mismatch.type === 'missing_in_hard') {
                        html += `<tr class="bg-yellow-50 border-b"><td class="p-3 font-medium text-yellow-700">Excel (Not in PDF)</td>${mismatch.data.map(cell => `<td class="p-3">${cell}</td>`).join('')}</tr>`;
                    } else {
                        const reorderedHardRow = softHeaders.map((sh, i) => mismatch.data[i] || '');
                        html += `<tr class="bg-red-50 border-b"><td class="p-3 font-medium text-red-600">PDF (Not in Excel)</td>${reorderedHardRow.map(cell => `<td class="p-3">${cell}</td>`).join('')}</tr>`;
                    }
                });

                html += `</tbody></table></div>`;
                resultsEl.innerHTML = html;

            } catch(e) {
                console.error(e);
                displayError('verify-results', e);
            } finally {
                hideLoader('verify-loader');
                resultsEl.classList.remove('hidden');
            }
        }
    </script>
</body>
</html>
